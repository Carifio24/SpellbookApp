package dnd.jon.spellbook;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.function.Function;
import java.util.stream.Collectors;


class Spellbook {

    static final int MIN_SPELL_LEVEL = 0;
    static final int MAX_SPELL_LEVEL = 9;

    static final Version V_2_0_0 = new Version(2, 0, 0);
    static final Version V_2_10_0 = new Version(2, 10 ,0);
    static final Version V_2_11_0 = new Version(2, 11 ,0);
    static final Version V_2_12_0 = new Version(2, 12 ,0);
    static final Version V_2_13_0 = new Version(2, 13 ,0);
    static final Version V_3_0_0 = new Version(3, 0, 0);
    static final Version V_3_0_4 = new Version(3,0,4);
    static final Version V_3_0_6 = new Version(3, 0, 6);
    static final Version V_3_5_0 = new Version(3, 5, 0);
    static final Version V_3_7_0 = new Version(3, 7, 0);
    static final Version V_4_1_0 = new Version(4, 1, 0);

    // static final Version[] VERSIONS = { V_2_0_0, V_2_10_0, V_2_11_0, V_2_11_0, V_2_12_0, V_2_13_0,
    //                                     V_3_0_4, V_3_0_6 };
    static private final Map<Version, Collection<Source>> SOURCES_NEW_IN_VERSION = new HashMap<>() {{
       put(V_2_0_0, Arrays.asList(Source.PLAYERS_HANDBOOK, Source.XANATHARS_GTE, Source.SWORD_COAST_AG));
       put(V_2_10_0, Arrays.asList(Source.TASHAS_COE));
       put(V_2_11_0, Arrays.asList(Source.ACQUISITIONS_INC, Source.EXPLORERS_GTW, Source.LOST_LAB_KWALISH, Source.RIME_FROSTMAIDEN));
       put(V_2_12_0, Arrays.asList(Source.FIZBANS_TOD));
       put(V_2_13_0, Arrays.asList(Source.STRIXHAVEN_COC));
       put(V_3_0_4, Arrays.asList(Source.ASTRAL_AG));
       put(V_3_0_6, Arrays.asList(Source.GUILDMASTERS_GTR));
       put(V_3_5_0, Arrays.asList(Source.TALDOREI_CSR, Source.SIGIL_OUTLANDS));
       put(V_3_7_0, Arrays.asList(Source.BOOK_OF_MT));
       put(V_4_1_0, Arrays.asList(Source.PLAYERS_HANDBOOK_2024));
    }};

    static Collection<Source> newSourcesForVersion(Version version) {
        return SOURCES_NEW_IN_VERSION.get(version);
    }

    static private Collection<Source> sourcesByCondition(Function<Version,Boolean> versionCondition) {
        return SOURCES_NEW_IN_VERSION.entrySet().stream().filter(entry -> versionCondition.apply(entry.getKey())).map(entry -> entry.getValue()).flatMap(Collection::stream).collect(Collectors.toList());
    }

    static Collection<Source> sourcesPriorToVersion(Version version) {
        return sourcesByCondition(v -> v.compareTo(version) < 0);
    }

    static Collection<Source> sourcesAddedAfterVersion(Version version) {
        return sourcesByCondition(v -> v.compareTo(version) > 0);
    }

    static Collection<CasterClass> classesAddedAfterVersion(Version version) {
        // We need the list to be mutable, so we wrap in the new ArrayList<>() call
        final List<CasterClass> classes = new ArrayList<>(Arrays.asList(CasterClass.values().clone()));
        if (version.compareTo(V_2_10_0) < 0) {
            classes.remove(CasterClass.ARTIFICER);
        }
        return classes;
    }

    static boolean spellsLinked(Spell first, Spell second) {
        return spellIDLinks.linkExists(first.getID(), second.getID());
    }

    static Integer linkedSpellID(Spell spell) {
        final Integer id = spell.getID();
        return SpellbookUtils.coalesce(spellIDLinks.getKey(id), spellIDLinks.getValue(id));
    }


    // Not the cleanest thing, but otherwise we're going to have to read this in from some sort of text file
    // Might as well not have to do the I/O
    static private final BidirectionalMap<Integer, Integer> spellIDLinks = new BidirectionalHashMap<>() {{
        put(243, 782);
        put(144, 678);
        put(353, 910);
        put(214, 751);
        put(354, 911);
        put(55, 587);
        put(247, 785);
        put(136, 670);
        put(298, 839);
        put(299, 840);
        put(184, 719);
        put(41, 572);
        put(110, 644);
        put(305, 847);
        put(284, 824);
        put(125, 660);
        put(143, 677);
        put(158, 693);
        put(276, 816);
        put(258, 798);
        put(335, 892);
        put(312, 854);
        put(291, 831);
        put(213, 750);
        put(54, 586);
        put(313, 855);
        put(165, 700);
        put(22, 553);
        put(283, 823);
        put(87, 619);
        put(265, 805);
        put(472, 866);
        put(7, 537);
        put(88, 620);
        put(250, 789);
        put(257, 797);
        put(434, 857);
        put(220, 757);
        put(61, 593);
        put(349, 907);
        put(172, 707);
        put(242, 781);
        put(221, 758);
        put(290, 830);
        put(62, 594);
        put(94, 626);
        put(334, 891);
        put(35, 567);
        put(14, 544);
        put(95, 627);
        put(264, 804);
        put(36, 568);
        put(227, 764);
        put(68, 600);
        put(316, 860);
        put(6, 536);
        put(380, 643);
        put(249, 788);
        put(21, 552);
        put(228, 765);
        put(69, 601);
        put(341, 898);
        put(102, 634);
        put(202, 739);
        put(342, 899);
        put(28, 559);
        put(475, 870);
        put(76, 608);
        put(109, 642);
        put(441, 886);
        put(139, 673);
        put(327, 882);
        put(272, 812);
        put(447, 902);
        put(333, 889);
        put(131, 665);
        put(231, 770);
        put(194, 730);
        put(246, 786);
        put(179, 714);
        put(297, 837);
        put(279, 819);
        put(120, 655);
        put(201, 738);
        put(356, 913);
        put(322, 875);
        put(153, 688);
        put(271, 811);
        put(75, 607);
        put(13, 543);
        put(43, 574);
        put(326, 881);
        put(307, 849);
        put(286, 826);
        put(127, 662);
        put(208, 745);
        put(49, 581);
        put(308, 850);
        put(160, 695);
        put(230, 769);
        put(278, 818);
        put(209, 746);
        put(50, 582);
        put(82, 614);
        put(260, 800);
        put(2, 532);
        put(83, 615);
        put(293, 833);
        put(215, 752);
        put(355, 912);
        put(56, 588);
        put(237, 776);
        put(216, 753);
        put(285, 825);
        put(57, 589);
        put(89, 621);
        put(138, 672);
        put(186, 721);
        put(300, 841);
        put(30, 562);
        put(238, 777);
        put(42, 573);
        put(90, 622);
        put(31, 563);
        put(222, 759);
        put(112, 646);
        put(1, 531);
        put(244, 783);
        put(16, 547);
        put(223, 760);
        put(64, 596);
        put(145, 679);
        put(336, 893);
        put(245, 784);
        put(97, 629);
        put(197, 734);
        put(337, 894);
        put(23, 554);
        put(252, 791);
        put(344, 901);
        put(159, 694);
        put(350, 908);
        put(189, 725);
        put(259, 799);
        put(63, 595);
        put(52, 585);
        put(292, 832);
        put(115, 650);
        put(196, 733);
        put(37, 569);
        put(397, 723);
        put(166, 701);
        put(317, 861);
        put(266, 806);
        put(38, 570);
        put(70, 602);
        put(167, 702);
        put(318, 862);
        put(8, 538);
        put(251, 790);
        put(71, 603);
        put(281, 821);
        put(203, 740);
        put(343, 900);
        put(104, 636);
        put(173, 708);
        put(273, 813);
        put(45, 577);
        put(174, 709);
        put(15, 545);
        put(96, 628);
        put(78, 610);
        put(210, 747);
        put(132, 666);
        put(310, 852);
        put(232, 771);
        put(438, 876);
        put(133, 667);
        put(181, 716);
        put(469, 863);
        put(103, 635);
        put(233, 772);
        put(122, 657);
        put(85, 617);
        put(357, 914);
        put(188, 724);
        put(29, 560);
        put(77, 609);
        put(239, 778);
        put(218, 755);
        put(140, 674);
        put(328, 883);
        put(240, 779);
        put(44, 575);
        put(51, 583);
        put(114, 648);
        put(195, 731);
        put(18, 549);
        put(147, 681);
        put(180, 715);
        put(280, 820);
        put(121, 656);
        put(148, 682);
        put(339, 896);
        put(154, 689);
        put(361, 920);
        put(345, 903);
        put(302, 843);
        put(217, 754);
        put(106, 639);
        put(155, 690);
        put(187, 722);
        put(346, 904);
        put(287, 827);
        put(128, 663);
        put(107, 640);
        put(309, 851);
        put(129, 664);
        put(113, 647);
        put(92, 624);
        put(161, 696);
        put(261, 801);
        put(331, 887);
        put(224, 761);
        put(162, 697);
        put(146, 680);
        put(3, 533);
        put(84, 616);
        put(294, 834);
        put(66, 598);
        put(198, 735);
        put(338, 895);
        put(99, 631);
        put(168, 703);
        put(58, 590);
        put(319, 872);
        put(268, 808);
        put(301, 842);
        put(169, 704);
        put(10, 540);
        put(320, 873);
        put(91, 623);
        put(360, 918);
        put(253, 792);
        put(25, 556);
        put(73, 605);
        put(32, 564);
        put(254, 793);
        put(17, 548);
        put(65, 597);
        put(467, 766);
        put(47, 579);
        put(98, 630);
        put(80, 612);
        put(39, 571);
        put(352, 909);
        put(24, 555);
        put(72, 604);
        put(267, 807);
        put(135, 669);
        put(323, 878);
        put(9, 539);
        put(235, 774);
        put(359, 917);
        put(454, 916);
        put(190, 726);
        put(205, 742);
        put(274, 814);
        put(175, 710);
        put(275, 815);
        put(116, 651);
        put(176, 711);
        put(117, 652);
        put(150, 685);
        put(134, 668);
        put(182, 717);
        put(234, 773);
        put(282, 822);
        put(123, 658);
        put(204, 741);
        put(183, 718);
        put(471, 865);
        put(105, 637);
        put(124, 659);
        put(156, 691);
        put(416, 767);
        put(46, 578);
        put(157, 692);
        put(329, 884);
        put(79, 611);
        put(348, 906);
        put(241, 780);
        put(289, 829);
        put(142, 676);
        put(211, 748);
        put(330, 885);
        put(311, 853);
        put(314, 858);
        put(212, 749);
        put(470, 864);
        put(372, 576);
        put(164, 699);
        put(315, 859);
        put(5, 535);
        put(86, 618);
        put(248, 787);
        put(149, 683);
        put(358, 915);
        put(340, 897);
        put(101, 633);
        put(219, 756);
        put(60, 592);
        put(141, 675);
        put(477, 871);
        put(303, 844);
        put(93, 625);
        put(304, 845);
        put(288, 828);
        put(108, 641);
        put(256, 795);
        put(19, 550);
        put(262, 802);
        put(163, 698);
        put(20, 551);
        put(4, 534);
        put(263, 803);
        put(295, 835);
        put(53, 584);
        put(296, 836);
        put(26, 557);
        put(473, 868);
        put(59, 591);
        put(269, 809);
        put(347, 905);
        put(170, 705);
        put(27, 558);
        put(11, 541);
        put(474, 869);
        put(270, 810);
        put(33, 565);
        put(171, 706);
        put(12, 542);
        put(255, 794);
        put(332, 888);
        put(34, 566);
        put(225, 762);
        put(193, 729);
        put(177, 712);
        put(226, 763);
        put(67, 599);
        put(229, 768);
        put(277, 817);
        put(118, 653);
        put(199, 736);
        put(178, 713);
        put(100, 632);
        put(119, 654);
        put(151, 686);
        put(200, 737);
        put(321, 874);
        put(152, 687);
        put(324, 879);
        put(74, 606);
        put(236, 775);
        put(137, 671);
        put(206, 743);
        put(185, 720);
        put(325, 880);
        put(306, 848);
        put(126, 661);
        put(207, 744);
        put(191, 727);
        put(48, 580);
        put(445, 890);
        put(111, 645);
        put(192, 728);
        put(81, 613);
    }};
}
