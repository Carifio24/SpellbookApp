package dnd.jon.spellbook;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.function.Function;
import java.util.stream.Collectors;


class Spellbook {

    static final int MIN_SPELL_LEVEL = 0;
    static final int MAX_SPELL_LEVEL = 9;

    static final Version V_2_0_0 = new Version(2, 0, 0);
    static final Version V_2_10_0 = new Version(2, 10 ,0);
    static final Version V_2_11_0 = new Version(2, 11 ,0);
    static final Version V_2_12_0 = new Version(2, 12 ,0);
    static final Version V_2_13_0 = new Version(2, 13 ,0);
    static final Version V_3_0_0 = new Version(3, 0, 0);
    static final Version V_3_0_4 = new Version(3,0,4);
    static final Version V_3_0_6 = new Version(3, 0, 6);
    static final Version V_3_5_0 = new Version(3, 5, 0);
    static final Version V_3_7_0 = new Version(3, 7, 0);
    static final Version V_4_0_5 = new Version(4, 0, 5);

    // static final Version[] VERSIONS = { V_2_0_0, V_2_10_0, V_2_11_0, V_2_11_0, V_2_12_0, V_2_13_0,
    //                                     V_3_0_4, V_3_0_6 };
    static private final Map<Version, Collection<Source>> SOURCES_NEW_IN_VERSION = new HashMap<>() {{
       put(V_2_0_0, Arrays.asList(Source.PLAYERS_HANDBOOK, Source.XANATHARS_GTE, Source.SWORD_COAST_AG));
       put(V_2_10_0, Arrays.asList(Source.TASHAS_COE));
       put(V_2_11_0, Arrays.asList(Source.ACQUISITIONS_INC, Source.EXPLORERS_GTW, Source.LOST_LAB_KWALISH, Source.RIME_FROSTMAIDEN));
       put(V_2_12_0, Arrays.asList(Source.FIZBANS_TOD));
       put(V_2_13_0, Arrays.asList(Source.STRIXHAVEN_COC));
       put(V_3_0_4, Arrays.asList(Source.ASTRAL_AG));
       put(V_3_0_6, Arrays.asList(Source.GUILDMASTERS_GTR));
       put(V_3_5_0, Arrays.asList(Source.TALDOREI_CSR, Source.SIGIL_OUTLANDS));
       put(V_3_7_0, Arrays.asList(Source.BOOK_OF_MT));
       put(V_4_0_5, Arrays.asList(Source.PLAYERS_HANDBOOK_2024));
    }};

    static Collection<Source> newSourcesForVersion(Version version) {
        return SOURCES_NEW_IN_VERSION.get(version);
    }

    static private Collection<Source> sourcesByCondition(Function<Version,Boolean> versionCondition) {
        return SOURCES_NEW_IN_VERSION.entrySet().stream().filter(entry -> versionCondition.apply(entry.getKey())).map(entry -> entry.getValue()).flatMap(Collection::stream).collect(Collectors.toList());
    }

    static Collection<Source> sourcesPriorToVersion(Version version) {
        return sourcesByCondition(v -> v.compareTo(version) < 0);
    }

    static Collection<Source> sourcesAddedAfterVersion(Version version) {
        return sourcesByCondition(v -> v.compareTo(version) > 0);
    }

    static Collection<CasterClass> classesAddedAfterVersion(Version version) {
        // We need the list to be mutable, so we wrap in the new ArrayList<>() call
        final List<CasterClass> classes = new ArrayList<>(Arrays.asList(CasterClass.values().clone()));
        if (version.compareTo(V_2_10_0) < 0) {
            classes.remove(CasterClass.ARTIFICER);
        }
        return classes;
    }

    static boolean spellsLinked(Spell first, Spell second) {
        return spellIDLinks.linkExists(first.getID(), second.getID());
    }

    static Integer linkedSpellID(Spell spell) {
        final Integer id = spell.getID();
        return SpellbookUtils.coalesce(spellIDLinks.getKey(id), spellIDLinks.getValue(id));
    }


    // Not the cleanest thing, but otherwise we're going to have to read this in from some sort of text file
    // Might as well not have to do the I/O
    static private final BidirectionalMap<Integer, Integer> spellIDLinks = new BidirectionalHashMap<>() {{
        put(469, 847);
        put(181, 709);
        put(34, 565);
        put(397, 715);
        put(155, 684);
        put(470, 848);
        put(96, 625);
        put(25, 555);
        put(162, 691);
        put(477, 855);
        put(303, 828);
        put(144, 673);
        put(217, 743);
        put(103, 632);
        put(288, 812);
        put(346, 884);
        put(206, 733);
        put(247, 771);
        put(136, 665);
        put(59, 589);
        put(277, 802);
        put(180, 708);
        put(347, 885);
        put(207, 734);
        put(295, 819);
        put(125, 655);
        put(302, 827);
        put(22, 553);
        put(225, 751);
        put(143, 672);
        put(66, 596);
        put(287, 811);
        put(441, 869);
        put(7, 537);
        put(258, 784);
        put(327, 865);
        put(188, 716);
        put(58, 588);
        put(205, 732);
        put(73, 603);
        put(194, 722);
        put(294, 818);
        put(14, 544);
        put(265, 791);
        put(106, 636);
        put(467, 755);
        put(65, 595);
        put(47, 577);
        put(250, 775);
        put(6, 536);
        put(319, 856);
        put(21, 552);
        put(80, 610);
        put(320, 857);
        put(352, 889);
        put(353, 890);
        put(235, 763);
        put(276, 801);
        put(120, 651);
        put(121, 652);
        put(91, 620);
        put(35, 566);
        put(338, 878);
        put(157, 686);
        put(98, 627);
        put(113, 643);
        put(234, 762);
        put(213, 739);
        put(131, 660);
        put(54, 584);
        put(305, 831);
        put(13, 543);
        put(175, 703);
        put(202, 729);
        put(246, 772);
        put(164, 693);
        put(416, 756);
        put(176, 704);
        put(46, 576);
        put(28, 558);
        put(337, 877);
        put(348, 886);
        put(79, 609);
        put(220, 746);
        put(61, 591);
        put(312, 838);
        put(182, 710);
        put(349, 887);
        put(2, 532);
        put(212, 738);
        put(471, 849);
        put(183, 711);
        put(372, 574);
        put(127, 657);
        put(227, 753);
        put(68, 598);
        put(27, 557);
        put(189, 717);
        put(201, 728);
        put(289, 813);
        put(260, 786);
        put(219, 745);
        put(163, 692);
        put(190, 718);
        put(60, 590);
        put(311, 837);
        put(290, 814);
        put(104, 633);
        put(314, 842);
        put(1, 531);
        put(16, 547);
        put(105, 634);
        put(137, 666);
        put(315, 843);
        put(208, 735);
        put(126, 656);
        put(138, 667);
        put(241, 768);
        put(271, 796);
        put(115, 646);
        put(53, 582);
        put(304, 829);
        put(145, 674);
        put(86, 615);
        put(329, 867);
        put(278, 803);
        put(30, 561);
        put(330, 868);
        put(152, 681);
        put(252, 777);
        put(196, 724);
        put(93, 622);
        put(296, 820);
        put(473, 852);
        put(226, 752);
        put(67, 597);
        put(229, 757);
        put(297, 821);
        put(474, 853);
        put(8, 538);
        put(170, 698);
        put(259, 785);
        put(230, 758);
        put(340, 880);
        put(171, 699);
        put(322, 859);
        put(355, 892);
        put(74, 604);
        put(307, 833);
        put(15, 545);
        put(177, 705);
        put(344, 882);
        put(266, 792);
        put(107, 637);
        put(178, 706);
        put(48, 578);
        put(251, 776);
        put(92, 621);
        put(339, 879);
        put(81, 611);
        put(222, 748);
        put(321, 858);
        put(114, 644);
        put(37, 568);
        put(354, 891);
        put(214, 740);
        put(158, 687);
        put(185, 713);
        put(55, 585);
        put(306, 832);
        put(285, 809);
        put(99, 628);
        put(159, 688);
        put(100, 629);
        put(132, 661);
        put(331, 870);
        put(343, 881);
        put(203, 730);
        put(361, 898);
        put(133, 662);
        put(165, 694);
        put(332, 871);
        put(166, 695);
        put(36, 567);
        put(298, 823);
        put(18, 549);
        put(139, 668);
        put(350, 888);
        put(299, 824);
        put(140, 669);
        put(184, 712);
        put(284, 808);
        put(324, 862);
        put(273, 798);
        put(147, 676);
        put(29, 559);
        put(191, 719);
        put(291, 815);
        put(445, 873);
        put(221, 747);
        put(62, 592);
        put(313, 839);
        put(3, 533);
        put(472, 850);
        put(317, 845);
        put(128, 658);
        put(434, 841);
        put(228, 754);
        put(69, 599);
        put(129, 659);
        put(10, 540);
        put(172, 700);
        put(261, 787);
        put(232, 760);
        put(146, 675);
        put(173, 701);
        put(87, 616);
        put(17, 548);
        put(316, 844);
        put(357, 894);
        put(76, 606);
        put(279, 804);
        put(88, 617);
        put(335, 875);
        put(268, 794);
        put(77, 607);
        put(280, 805);
        put(153, 682);
        put(253, 778);
        put(94, 623);
        put(231, 759);
        put(154, 683);
        put(51, 581);
        put(254, 779);
        put(116, 647);
        put(95, 624);
        put(475, 854);
        put(9, 539);
        put(198, 725);
        put(117, 648);
        put(356, 893);
        put(160, 689);
        put(101, 630);
        put(161, 690);
        put(75, 605);
        put(123, 654);
        put(102, 631);
        put(334, 874);
        put(32, 563);
        put(345, 883);
        put(267, 793);
        put(43, 572);
        put(108, 638);
        put(135, 664);
        put(49, 579);
        put(109, 639);
        put(168, 697);
        put(50, 580);
        put(82, 612);
        put(39, 570);
        put(83, 613);
        put(215, 741);
        put(24, 554);
        put(56, 586);
        put(286, 810);
        put(216, 742);
        put(57, 587);
        put(308, 834);
        put(42, 571);
        put(309, 835);
        put(150, 680);
        put(134, 663);
        put(333, 872);
        put(293, 817);
        put(223, 749);
        put(64, 594);
        put(5, 535);
        put(38, 569);
        put(300, 825);
        put(257, 783);
        put(301, 826);
        put(142, 671);
        put(274, 799);
        put(204, 731);
        put(326, 864);
        put(72, 602);
        put(275, 800);
        put(193, 721);
        put(264, 790);
        put(248, 773);
        put(359, 897);
        put(167, 696);
        put(89, 618);
        put(149, 678);
        put(454, 896);
        put(19, 550);
        put(249, 774);
        put(63, 593);
        put(281, 806);
        put(111, 642);
        put(90, 619);
        put(20, 551);
        put(4, 534);
        put(52, 583);
        put(141, 670);
        put(282, 807);
        put(325, 863);
        put(156, 685);
        put(256, 781);
        put(70, 600);
        put(118, 649);
        put(97, 626);
        put(11, 541);
        put(262, 788);
        put(148, 677);
        put(71, 601);
        put(119, 650);
        put(192, 720);
        put(292, 816);
        put(12, 542);
        put(263, 789);
        put(45, 575);
        put(336, 876);
        put(269, 795);
        put(318, 846);
        put(78, 608);
        put(210, 736);
        put(211, 737);
        put(255, 780);
        put(233, 761);
        put(174, 702);
        put(26, 556);
        put(358, 895);
        put(218, 744);
        put(310, 836);
        put(33, 564);
        put(44, 573);
    }};
}
